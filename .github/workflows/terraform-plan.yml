###############################################################################
# CI Workflow â€” Terraform Plan on Pull Request
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Design decisions:
#
#   â€¢ TRIGGER: Runs on every PR that modifies terraform/ files.
#     Also runs on manual dispatch for ad-hoc testing.
#
#   â€¢ STEPS: fmt check â†’ validate â†’ plan â†’ PR comment
#     fmt and validate catch syntax errors BEFORE the expensive plan step.
#     Plan output is posted as a PR comment so reviewers see exactly what
#     will change without running Terraform locally.
#
#   â€¢ OIDC AUTHENTICATION:
#     Uses GitHub's OIDC provider to assume an IAM role â€” no long-lived
#     AWS access keys stored in repository secrets.  The IAM role's trust
#     policy scopes access to this repository only.
#
#   â€¢ CONCURRENCY:
#     Only one plan runs per PR at a time.  New pushes cancel in-progress
#     runs to avoid stale plan comments.
#
#   â€¢ MATRIX (future):
#     To add staging/prod environments, add entries to the matrix strategy.
#     Each environment uses its own IAM role and working directory.
#
#   â€¢ SECURITY:
#     - Plan runs with read-only DynamoDB lock (no state modification)
#     - PR comment uses github-actions bot identity
#     - Secrets never printed in logs (OIDC handles credential rotation)
###############################################################################

name: "Terraform Plan"

on:
    pull_request:
        branches: [main]
        paths:
            - "terraform/**"
            - ".github/workflows/terraform-plan.yml"
            - ".github/actions/setup-terraform/**"
    workflow_dispatch:

# Cancel in-progress runs for the same PR â€” new push supersedes old plan
concurrency:
    group: terraform-plan-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

# Minimum permissions â€” OIDC needs id-token:write, PR comment needs pr:write
permissions:
    id-token: write # Required for OIDC â†’ AWS STS AssumeRoleWithWebIdentity
    contents: read # Required to checkout the repository
    pull-requests: write # Required to post plan output as PR comment

env:
    TF_IN_AUTOMATION: "true"
    TF_INPUT: "false"

jobs:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
    # Job 1: Format Check (fast, no AWS credentials needed)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
    fmt:
        name: "Format Check"
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "1.9.8"

            - name: Terraform Format Check
              id: fmt
              run: terraform fmt -check -recursive -diff terraform/
              continue-on-error: true

            - name: Comment on format failure
              if: steps.fmt.outcome == 'failure'
              uses: actions/github-script@v7
              with:
                  script: |
                      const body = `### âš ï¸ Terraform Format Check Failed

                      Some files are not properly formatted. Run \`terraform fmt -recursive terraform/\` locally and push the changes.

                      <details>
                      <summary>Show formatting diff</summary>

                      \`\`\`diff
                      Run: terraform fmt -check -recursive -diff terraform/
                      \`\`\`
                      </details>`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body
                      });

            - name: Fail on format issues
              if: steps.fmt.outcome == 'failure'
              run: exit 1

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
    # Job 2: Validate + Plan (per environment)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
    plan:
        name: "Plan (${{ matrix.environment }})"
        runs-on: ubuntu-latest
        needs: fmt
        strategy:
            fail-fast: false
            matrix:
                include:
                    - environment: dev
                      working-directory: terraform/environments/dev
                      aws-role-arn-secret: AWS_ROLE_ARN_DEV
                      # Add more environments as needed:
                      # - environment: staging
                      #   working-directory: terraform/environments/staging
                      #   aws-role-arn-secret: AWS_ROLE_ARN_STAGING

        defaults:
            run:
                working-directory: ${{ matrix.working-directory }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            # â”€â”€ Setup (OIDC + Terraform + Init) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
            - name: Setup Terraform & AWS
              uses: ./.github/actions/setup-terraform
              with:
                  aws-role-arn: ${{ secrets[matrix.aws-role-arn-secret] }}
                  working-directory: ${{ matrix.working-directory }}

            # â”€â”€ Validate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
            - name: Terraform Validate
              id: validate
              run: terraform validate -no-color

            # â”€â”€ Plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
            # -detailed-exitcode: 0 = no changes, 1 = error, 2 = changes present
            - name: Terraform Plan
              id: plan
              run: |
                  terraform plan -no-color -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt
                  echo "exitcode=$?" >> "$GITHUB_OUTPUT"
              continue-on-error: true

            # â”€â”€ Post Plan to PR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
            - name: Comment Plan on PR
              uses: actions/github-script@v7
              if: github.event_name == 'pull_request'
              env:
                  PLAN_EXIT: ${{ steps.plan.outputs.exitcode }}
                  ENVIRONMENT: ${{ matrix.environment }}
              with:
                  script: |
                      const fs = require('fs');
                      const planFile = '${{ matrix.working-directory }}/plan_output.txt';
                      let planOutput = 'Plan output not available';

                      if (fs.existsSync(planFile)) {
                        planOutput = fs.readFileSync(planFile, 'utf8');
                      }

                      // Truncate if too long for GitHub comment (max 65536 chars)
                      const maxLength = 60000;
                      if (planOutput.length > maxLength) {
                        planOutput = planOutput.substring(0, maxLength) + '\n\n... (truncated â€” see workflow logs for full output)';
                      }

                      const exitCode = parseInt(process.env.PLAN_EXIT || '1');
                      let statusIcon, statusText;
                      if (exitCode === 0) {
                        statusIcon = 'âœ…';
                        statusText = 'No changes detected';
                      } else if (exitCode === 2) {
                        statusIcon = 'ğŸ“‹';
                        statusText = 'Changes detected';
                      } else {
                        statusIcon = 'âŒ';
                        statusText = 'Plan failed';
                      }

                      const body = `### ${statusIcon} Terraform Plan â€” \`${process.env.ENVIRONMENT}\`

                      **Status**: ${statusText}

                      <details>
                      <summary>Show plan output</summary>

                      \`\`\`hcl
                      ${planOutput}
                      \`\`\`
                      </details>

                      *Workflow: ${context.workflow} | Run: [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;

                      // Find and update existing comment (avoid spam on multiple pushes)
                      const { data: comments } = await github.rest.issues.listComments({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                      });

                      const marker = `Terraform Plan â€” \`${process.env.ENVIRONMENT}\``;
                      const existing = comments.find(c =>
                        c.user.type === 'Bot' && c.body.includes(marker)
                      );

                      if (existing) {
                        await github.rest.issues.updateComment({
                          comment_id: existing.id,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body,
                        });
                      } else {
                        await github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body,
                        });
                      }

            # â”€â”€ Upload plan artifact for apply job â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
            - name: Upload Plan Artifact
              if: steps.plan.outputs.exitcode == '2'
              uses: actions/upload-artifact@v4
              with:
                  name: tfplan-${{ matrix.environment }}
                  path: ${{ matrix.working-directory }}/tfplan
                  retention-days: 5

            # â”€â”€ Fail the job if plan errored â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
            - name: Check Plan Status
              if: steps.plan.outputs.exitcode == '1'
              run: exit 1
